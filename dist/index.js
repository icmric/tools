async function e(e,t){let a,r,l;null==e.body.tool?(a=e.url.split(/\/|\?/),l=a[1],r=h(e.query)):(l=e.body.tool,r=h(e.body.body));const{services:n,getSchema:s}=t,{ItemsService:i}=n,o=new i("api_parents",{schema:await s(),accountability:e.accountability});let u;try{u=await o.readByQuery({fields:["*","api.*"],filter:{title:{_eq:l}}})}catch(e){}if(""==u)return o.readByQuery({fields:["title"]});let c=u[0].api,y=u[0];t.data={},t.data.reqAccountability=e.accountability,t.data.$request=r,t.data.$tool={},t.data.$tool.main=q(y.main);let d={};if(null!=u[0].extra_values)for(let e=0;e<u[0].extra_values.length;e++){let t=q(u[0].extra_values[e].key),a=q(u[0].extra_values[e].value);d[t]=a}t.data.extraValues=d;let f,p={request:null};return 0==(null==c.request||c.request=={})&&(p.request=q(c.request)),t.data.apiResponse=await async function(e,t){let a,{method:r,url:l,header:n}=e,s={};l=m(l),null!=n&&n.forEach((e=>{s[e.key]=e.value}));let i={method:e.method,headers:null!=s?s:null};null!=t&&(i.body=JSON.stringify(t));return a=await fetch(l,i).then((e=>e.json())),p.response=a,a}(c,p.request),f=null!=c.transform?await q(c.transform):t.data.apiResponse,f;function h(e){for(let t in e)if(e.hasOwnProperty(t)){let a=t.replace("$request.",""),r=e[t];"string"==typeof r?r=r.replace("$request.",""):"object"==typeof r&&null!==r&&(r=h(r)),a!==t&&delete e[t],e[a]=r}return e}function m(e){return e.replace(/{(.*)}/g,((e,a)=>{let r=("data."+a).trim().split(".").reduce(((e,t)=>e&&"object"==typeof e?e[t]:"Blank"),t);let l;return l="string"==typeof r?r:JSON.stringify(r),void 0!==l?l:e}))}function q(e){if("string"==typeof e){let t=m(e);try{return JSON.parse(t)}catch(e){return t}}else{if(Array.isArray(e))return e.map((e=>q(e)));if(null!==e&&"object"==typeof e){const t={};for(const a in e)e.hasOwnProperty(a)&&(t[a]=q(e[a]));return t}}return e}}let t,a;var r=(r,l)=>{r.get("/*",(async(r,n)=>{try{t=r,a=l;let s=await e(t,a);n.send(s)}catch(e){n.send("Request failed, Please log in or check your permissions! "+e)}})),r.post("/*",(async(r,n)=>{try{t=r,a=l;let s=await e(t,a);n.send(s)}catch(e){n.send("Request failed, Please log in or check your permissions! "+e)}}))};export{a as contextExport,r as default,t as reqExport};
